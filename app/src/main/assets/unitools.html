<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Toolkit</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* ------------------- */
        /* --- CSS STYLING --- */
        /* ------------------- */

        /* --- 1. Global Styles & Color Palette --- */
        :root {
            --color-bg-main: #f0f0f0;
            --color-bg-element: #E1F5FE; /* Card and Modal background */
            --color-primary-accent: #007BFF; /* A more standard, readable blue */
            --color-accent-shade: #6f42c1; /* A nice purple for secondary buttons */
            --color-text-primary: #212529; /* Dark text for light background */
            --color-text-secondary: #6c757d; /* Dark grey for secondary text */
            --color-border: rgba(0, 0, 0, 0.1);
            --color-hover-bg: rgba(0, 123, 255, 0.1);
            --font-family: 'Segoe UI', 'Roboto', system-ui, sans-serif;
            --border-radius: 12px; /* Increased for rounder corners */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--color-bg-main);
            color: var(--color-text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* --- 2. Header & Navigation (MODIFIED) --- */
        .header {
            background-color: var(--color-bg-main);
            padding: 1rem 5%;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            border-bottom: 1px solid #42F8F5; /* <-- YOUR CHANGE IS HERE */
        }

        .logo a {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--color-text-primary);
            text-decoration: none;
        }

        .logo span {
            color: var(--color-primary-accent);
        }

        .navbar, .menu-toggle {
            display: none;
        }

        /* --- 3. Main Content & Tool Grid --- */
        .main-content {
            padding: 2rem 5%;
        }

        .hero-section {
            text-align: center;
            margin-bottom: 3rem;
        }

        .hero-section p {
            font-size: 1.1rem;
            color: var(--color-text-secondary);
            max-width: 700px;
            margin: 0 auto;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        /* --- 4. Tool Card Styling --- */
        .tool-card {
            background-color: var(--color-bg-element);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            cursor: pointer;
            text-align: center;
        }

        .tool-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .tool-card .card-icon {
            font-size: 2.5rem;
            color: var(--color-primary-accent);
            margin-bottom: 1rem;
        }

        .tool-card h2 {
            font-size: 1.2rem;
            color: var(--color-text-primary);
            word-break: break-word;
        }

        /* --- 5. Buttons & Inputs --- */
        .btn {
            background-color: var(--color-primary-accent);
            color: #fff;
            border: 2px solid var(--color-primary-accent);
            border-radius: var(--border-radius);
            padding: 0.75rem 1.5rem;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .btn:hover, .btn:focus {
            background-color: #0056b3;
            border-color: #0056b3;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
            outline: none;
        }

        .btn-secondary {
            background-color: var(--color-text-secondary);
            border-color: var(--color-text-secondary);
        }

        .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #5a6268;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.4);
        }

        .tool-input, .tool-select, .tool-textarea {
            width: 100%; padding: 0.75rem; background-color: #fff; border: 1px solid #ccc;
            border-radius: var(--border-radius); color: var(--color-text-primary);
            font-size: 1rem; margin-bottom: 1rem;
        }
        .tool-input:focus, .tool-select:focus, .tool-textarea:focus {
            outline: none; border-color: var(--color-primary-accent); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
        .tool-textarea { min-height: 120px; resize: vertical; }
        .result-box {
            background-color: #fff; border: 1px solid #ccc; padding: 1rem; margin-top: 1rem;
            border-radius: var(--border-radius); word-wrap: break-word; min-height: 50px;
        }

        /* --- 6. Modal --- */
        .modal-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-container.show { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--color-bg-main); padding: 2.5rem; border-radius: var(--border-radius);
            border: 1px solid var(--color-border); box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            width: 90%; max-width: 700px; max-height: 90vh;
            overflow-y: auto; position: relative; transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-container.show .modal-content { transform: scale(1); }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #42F8F5;
        }
        .modal-header h2 { font-size: 2rem; color: var(--color-primary-accent); }
        .modal-description {
            font-size: 1.1rem; color: var(--color-text-secondary); margin-bottom: 2rem; text-align: center;
        }
        .modal-close-btn {
            background: none; border: none; color: var(--color-text-secondary);
            font-size: 2rem; cursor: pointer; transition: color 0.3s, transform 0.3s;
        }
        .modal-close-btn:hover { color: var(--color-primary-accent); transform: rotate(90deg); }
        .tool-section { display: flex; flex-direction: column; gap: 1rem; }
        .tool-controls { display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; }

        /* --- 7. Utility & Helper Classes --- */
        .hidden { display: none !important; }
        .mt-1 { margin-top: 1rem; }

        /* --- 8. Responsive Design --- */
        @media (max-width: 992px) {
            .tools-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .modal-content { width: 95%; padding: 1.5rem; }
            .modal-header h2 { font-size: 1.5rem; }
        }
        @media (max-width: 600px) {
            .tools-grid { grid-template-columns: repeat(2, 1fr); gap: 1rem; }
            .tool-card h2 { font-size: 1rem; }
            .hero-section p { font-size: 1rem; }
        }

    </style>
</head>
<body>
    <header class="header">
        <div class="logo" align="center">
            <a href="#">Ultimate <span>Tool</span>kit</a>
        </div>
    </header>

    <main class="main-content">
        <section class="hero-section">
            <p>Tired of a cluttered phone with single-purpose apps? Our Multi-Tool app combines all your essential utilities into one powerful and easy-to-use toolkit. Whether you're doing a DIY project, traveling, or just need a quick measurement, we've got you covered.</p>
        </section>
        <section id="tools">
            <div class="tools-grid"></div>
        </section>
    </main>

    <div id="modal-container" class="modal-container">
        <div id="modal-content" class="modal-content"></div>
    </div>

    <div id="notification" class="notification" style="opacity: 0; bottom: -100px;"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const toolsGrid = document.querySelector('.tools-grid');
        const modalContainer = document.getElementById('modal-container');
        const modalContent = document.getElementById('modal-content');
        const notificationEl = document.getElementById('notification');

        const tools = [
            { id: "image-converter", title: "Image Converter", desc: "Convert images to JPG, PNG, or WEBP format right in your browser.", icon: "fa-retweet" },
            { id: "image-compressor", title: "Image Compressor", desc: "Reduce image file sizes with adjustable quality for faster web loading.", icon: "fa-compress-arrows-alt" },
            { id: "image-cropper", title: "Image Cropper", desc: "Crop and resize your images with a simple, interactive interface.", icon: "fa-crop-alt" },
            { id: "video-converter", title: "Video Converter (to WEBM)", desc: "Re-record video clips to the efficient WEBM format. (Browser-based)", icon: "fa-video" },
            { id: "audio-converter", title: "Audio Converter (to WEBM)", desc: "Re-record audio to the efficient WEBM/Opus format. (Browser-based)", icon: "fa-music" },
            { id: "audio-trimmer", title: "Audio Trimmer", desc: "Cut sections of your audio files. Load, select a range, and save.", icon: "fa-cut" },
            { id: "age-calculator", title: "Age Calculator", desc: "Calculate exact age from a date of birth to the current date.", icon: "fa-calendar-alt" },
            { id: "emi-calculator", title: "EMI Calculator", desc: "Calculate your Equated Monthly Installment for loans.", icon: "fa-percent" },
            { id: "sip-calculator", title: "SIP Calculator", desc: "Estimate the returns on your Systematic Investment Plan (SIP).", icon: "fa-chart-line" },
            { id: "qr-code-generator", title: "QR Code Generator", desc: "Create and download QR codes for URLs, text, and more.", icon: "fa-qrcode" },
            { id: "password-generator", title: "Password Generator", desc: "Generate strong, secure, and customizable passwords.", icon: "fa-key" },
            { id: "word-counter", title: "Word & Character Counter", desc: "Count words, characters, sentences, and paragraphs in your text.", icon: "fa-file-word" },
            { id: "base64-encoder", title: "Base64 Encoder/Decoder", desc: "Encode text to Base64 or decode from Base64 back to text.", icon: "fa-exchange-alt" },
            { id: "color-picker", title: "Color Picker & Converter", desc: "Pick a color and get its HEX, RGB, and HSL values.", icon: "fa-palette" },
            { id: "text-to-speech", title: "Text to Speech", desc: "Convert written text into natural-sounding speech with various voices.", icon: "fa-volume-up" },
            { id: "speech-to-text", title: "Speech to Text", desc: "Transcribe your spoken words into text using your microphone.", icon: "fa-microphone-alt" },
            { id: "json-formatter", title: "JSON Formatter", desc: "Validate, format, and beautify your JSON data for readability.", icon: "fa-code" },
            { id: "unit-converter", title: "Unit Converter", desc: "Convert between various units of length, weight, and temperature.", icon: "fa-ruler-combined" },
            { id: "bmi-calculator", title: "BMI Calculator", desc: "Calculate your Body Mass Index using metric or imperial units.", icon: "fa-weight" },
            { id: "timer-stopwatch", title: "Timer / Stopwatch", desc: "A versatile timer and stopwatch for all your timing needs.", icon: "fa-stopwatch" },
        ];

        function renderToolCards() {
            toolsGrid.innerHTML = tools.map(tool => `
                <article class="tool-card" data-tool-id="${tool.id}">
                    <i class="fas ${tool.icon} card-icon"></i>
                    <h2>${tool.title}</h2>
                </article>
            `).join('');
        }

        let notificationTimeout;
        function showNotification(message, duration = 3000) {
            clearTimeout(notificationTimeout);
            notificationEl.textContent = message;
            notificationEl.style.opacity = '1';
            notificationEl.style.bottom = '20px';
            notificationTimeout = setTimeout(() => {
                notificationEl.style.opacity = '0';
                notificationEl.style.bottom = '-100px';
            }, duration);
        }

        function openModal(toolId) {
            const toolData = tools.find(t => t.id === toolId);
            const tool = toolImplementations[toolId];
            if (!toolData || !tool) return;
            const { content, onMount } = tool();
            modalContent.innerHTML = `
                <div class="modal-header">
                    <h2>${toolData.title}</h2>
                    <button id="modal-close-btn" class="modal-close-btn">Ã—</button>
                </div>
                <p class="modal-description">${toolData.desc}</p>
                <div class="tool-section">
                    ${content}
                </div>
            `;
            modalContainer.classList.add('show');
            document.body.style.overflow = 'hidden';
            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
            if (onMount) {
                onMount();
            }
        }

        function closeModal() {
            modalContainer.classList.remove('show');
            document.body.style.overflow = 'auto';
            modalContent.innerHTML = '';
        }

        toolsGrid.addEventListener('click', (e) => {
            const card = e.target.closest('.tool-card');
            if (card) {
                const toolId = card.dataset.toolId;
                openModal(toolId);
            }
        });

        modalContainer.addEventListener('click', (e) => {
            if (e.target === modalContainer) { closeModal(); }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modalContainer.classList.contains('show')) { closeModal(); }
        });

        // --- TOOL IMPLEMENTATIONS ---
        const toolImplementations = {
            'image-converter': () => ({
                title: 'Image Converter',
                content: `
                    <input type="file" id="img-conv-input" class="tool-input" accept="image/*">
                    <div class="tool-controls">
                        <select id="img-conv-format" class="tool-select">
                            <option value="image/jpeg">JPEG</option>
                            <option value="image/png">PNG</option>
                            <option value="image/webp">WEBP</option>
                        </select>
                        <button id="img-conv-btn" class="btn">Convert</button>
                    </div>
                    <div id="img-conv-output" class="text-center mt-1"></div>
                `,
                onMount: () => {
                    const input = document.getElementById('img-conv-input');
                    const convertBtn = document.getElementById('img-conv-btn');
                    const formatSelect = document.getElementById('img-conv-format');
                    const outputDiv = document.getElementById('img-conv-output');

                    convertBtn.addEventListener('click', () => {
                        if (input.files.length === 0) {
                            showNotification("Please select an image first.", 3000);
                            return;
                        }
                        const file = input.files[0];
                        const reader = new FileReader();

                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                canvas.width = img.width;
                                canvas.height = img.height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0);

                                const format = formatSelect.value;
                                const extension = format.split('/')[1];
                                const dataUrl = canvas.toDataURL(format);

                                outputDiv.innerHTML = `
                                    <p>Conversion successful!</p>
                                    <img src="${dataUrl}" style="max-width:100%; margin-top:1rem; border-radius:var(--border-radius);">
                                    <button class="btn mt-1" id="download-converted-image">Download Image</button>
                                `;

                                // Event listener for the new download button
                                document.getElementById('download-converted-image').addEventListener('click', () => {
                                    // Modified to call Android.downloadFile directly with base64 data
                                    if (window.Android && typeof window.Android.downloadFile === 'function') {
                                        window.Android.downloadFile(dataUrl, `converted-image.${extension}`);
                                        showNotification("Download initiated via Android.", 3000);
                                    } else {
                                        // Fallback for browsers or if Android interface is not set up
                                        const a = document.createElement('a');
                                        a.href = dataUrl;
                                        a.download = `converted-image.${extension}`;
                                        document.body.appendChild(a);
                                        a.click();
                                        document.body.removeChild(a);
                                        showNotification("Download started (browser fallback).", 3000);
                                    }
                                });
                            };
                            img.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    });
                }
            }),
            'image-compressor': () => ({
                title: 'Image Compressor',
                content: `
                    <input type="file" id="img-comp-input" class="tool-input" accept="image/jpeg,image/png">
                    <label for="img-comp-quality">Quality (0.1 to 1.0):</label>
                    <input type="range" id="img-comp-quality" min="0.1" max="1.0" step="0.1" value="0.7" class="tool-input">
                    <button id="img-comp-btn" class="btn">Compress</button>
                    <div id="img-comp-output" class="mt-1"></div>
                `,
                onMount: () => {
                    const input = document.getElementById('img-comp-input');
                    const qualitySlider = document.getElementById('img-comp-quality');
                    const compressBtn = document.getElementById('img-comp-btn');
                    const outputDiv = document.getElementById('img-comp-output');

                    compressBtn.addEventListener('click', () => {
                        if (input.files.length === 0) {
                            showNotification("Please select an image.", 3000);
                            return;
                        }
                        const file = input.files[0];
                        if (file.type !== 'image/jpeg' && file.type !== 'image/png') {
                            showNotification("Only JPG and PNG images are supported for compression.", 4000);
                            return;
                        }
                        const reader = new FileReader();

                        reader.onload = e => {
                            const img = new Image();
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                canvas.width = img.width;
                                canvas.height = img.height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0);

                                const quality = parseFloat(qualitySlider.value);
                                const dataUrl = canvas.toDataURL(file.type, quality);
                                const originalSize = (file.size / 1024).toFixed(2);
                                const newSize = (dataUrl.length * 0.75 / 1024).toFixed(2); // Approximation for Base64

                                outputDiv.innerHTML = `
                                    <p>Original Size: ${originalSize} KB | New Size: ${newSize} KB</p>
                                    <img src="${dataUrl}" style="max-width:100%; margin-top:1rem; border-radius:var(--border-radius);">
                                    <button class="btn mt-1" id="download-compressed-image">Download Image</button>
                                `;

                                // Event listener for the new download button
                                document.getElementById('download-compressed-image').addEventListener('click', () => {
                                    if (window.Android && typeof window.Android.downloadFile === 'function') {
                                        // Determine file extension based on original type for more accuracy
                                        const extension = file.type.split('/')[1] === 'jpeg' ? 'jpg' : file.type.split('/')[1];
                                        window.Android.downloadFile(dataUrl, `compressed-image.${extension}`);
                                        showNotification("Download initiated via Android.", 3000);
                                    } else {
                                        const a = document.createElement('a');
                                        a.href = dataUrl;
                                        a.download = `compressed-image.jpg`; // Fallback to .jpg for simplicity
                                        document.body.appendChild(a);
                                        a.click();
                                        document.body.removeChild(a);
                                        showNotification("Download started (browser fallback).", 3000);
                                    }
                                });
                            };
                            img.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    });
                }
            }),
            'image-cropper': () => ({
                title: 'Image Cropper',
                content: `
                    <input type="file" id="img-crop-input" class="tool-input" accept="image/*">
                    <div id="img-crop-container" style="position: relative; max-width: 100%; margin-top: 1rem;"></div>
                    <button id="img-crop-btn" class="btn mt-1 hidden">Crop & Download</button>
                    <div id="img-crop-output" class="mt-1"></div>
                `,
                onMount: () => {
                    showNotification("Cropper is a basic implementation. More features coming soon!", 4000);
                    const input = document.getElementById('img-crop-input');
                    const container = document.getElementById('img-crop-container');
                    const cropBtn = document.getElementById('img-crop-btn');
                    let canvas, ctx, img, selection = {};

                    input.addEventListener('change', e => {
                        if (e.target.files.length === 0) return;
                        const reader = new FileReader();
                        reader.onload = res => {
                            img = new Image();
                            img.onload = () => {
                                container.innerHTML = '';
                                canvas = document.createElement('canvas');
                                canvas.width = img.width;
                                canvas.height = img.height;
                                container.append(canvas);
                                canvas.style.maxWidth = '100%';
                                ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0);
                                cropBtn.classList.remove('hidden');

                                let startX, startY, isDrawing = false;
                                canvas.onmousedown = (e) => {
                                    startX = e.offsetX;
                                    startY = e.offsetY;
                                    isDrawing = true;
                                };
                                canvas.onmousemove = (e) => {
                                    if (!isDrawing) return;
                                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                                    ctx.drawImage(img, 0, 0);
                                    ctx.strokeStyle = 'red';
                                    ctx.lineWidth = 2;
                                    ctx.strokeRect(startX, startY, e.offsetX - startX, e.offsetY - startY);
                                };
                                canvas.onmouseup = (e) => {
                                    isDrawing = false;
                                    canvas.onmousemove = null;
                                    selection = {
                                        x: Math.min(startX, e.offsetX),
                                        y: Math.min(startY, e.offsetY),
                                        w: Math.abs(e.offsetX - startX),
                                        h: Math.abs(e.offsetY - startY)
                                    };
                                };
                            };
                            img.src = res.target.result;
                        };
                        reader.readAsDataURL(e.target.files[0]);
                    });

                    cropBtn.addEventListener('click', () => {
                        if (!selection.w || !selection.h) {
                            showNotification("Please select an area to crop.", 3000);
                            return;
                        }
                        const cropCanvas = document.createElement('canvas');
                        cropCanvas.width = selection.w;
                        cropCanvas.height = selection.h;
                        const cropCtx = cropCanvas.getContext('2d');
                        cropCtx.drawImage(img, selection.x, selection.y, selection.w, selection.h, 0, 0, selection.w, selection.h);
                        const dataUrl = cropCanvas.toDataURL('image/png');

                        if (window.Android && typeof window.Android.downloadFile === 'function') {
                            window.Android.downloadFile(dataUrl, 'cropped-image.png');
                            showNotification("Image cropped and download initiated via Android.", 3000);
                        } else {
                            const link = document.createElement('a');
                            link.href = dataUrl;
                            link.download = 'cropped-image.png';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            showNotification("Image cropped and download started (browser fallback).", 3000);
                        }
                    });
                }
            }),
            'video-converter': () => ({
                title: 'Video Converter (to WEBM)',
                content: `
                    <input type="file" id="video-conv-input" class="tool-input" accept="video/*">
                    <video id="video-conv-preview" controls class="hidden" style="max-width: 100%; margin-top: 1rem;"></video>
                    <div id="video-conv-controls" class="tool-controls mt-1 hidden">
                        <button id="video-conv-start-btn" class="btn">Start Conversion</button>
                    </div>
                    <div id="video-conv-output" class="mt-1"></div>
                `,
                onMount: () => {
                    const input = document.getElementById('video-conv-input');
                    const preview = document.getElementById('video-conv-preview');
                    const controls = document.getElementById('video-conv-controls');
                    const startBtn = document.getElementById('video-conv-start-btn');
                    const outputDiv = document.getElementById('video-conv-output');
                    let stream, mediaRecorder, chunks = [];

                    input.addEventListener('change', e => {
                        if (e.target.files.length === 0) return;
                        const file = e.target.files[0];
                        const url = URL.createObjectURL(file);
                        preview.src = url;
                        preview.classList.remove('hidden');
                        controls.classList.remove('hidden');
                    });

                    startBtn.addEventListener('click', () => {
                        if (!preview.src) {
                            showNotification("Please load a video first.", 3000);
                            return;
                        }
                        showNotification("Conversion started... please wait.", 5000);
                        startBtn.disabled = true;
                        startBtn.textContent = "Converting...";

                        stream = preview.captureStream();
                        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });

                        mediaRecorder.ondataavailable = e => chunks.push(e.data);

                        mediaRecorder.onstop = () => {
                            const blob = new Blob(chunks, { type: 'video/webm' });
                            const url = URL.createObjectURL(blob);
                            outputDiv.innerHTML = `
                                <p>Conversion to WEBM complete!</p>
                                <button class="btn mt-1" id="download-converted-video">Download WEBM</button>
                            `;

                            document.getElementById('download-converted-video').addEventListener('click', () => {
                                if (window.Android && typeof window.Android.downloadFile === 'function') {
                                    const reader = new FileReader();
                                    reader.onloadend = function() {
                                        window.Android.downloadFile(reader.result, 'converted-video.webm');
                                        showNotification("Video download initiated via Android.", 3000);
                                    };
                                    reader.readAsDataURL(blob);
                                } else {
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = 'converted-video.webm';
                                    document.body.appendChild(a);
                                    a.click();
                                    document.body.removeChild(a);
                                    showNotification("Video download started (browser fallback).", 3000);
                                }
                            });
                            startBtn.disabled = false;
                            startBtn.textContent = "Start Conversion";
                            chunks = [];
                        };
                        preview.play();
                        preview.onplaying = () => mediaRecorder.start();
                        preview.onended = () => mediaRecorder.stop();
                    });
                }
            }),
            'audio-converter': () => ({
                title: 'Audio Converter (to WEBM/Opus)',
                content: `
                    <input type="file" id="audio-conv-input" class="tool-input" accept="audio/*">
                    <audio id="audio-conv-preview" controls class="hidden" style="width: 100%; margin-top: 1rem;"></audio>
                    <button id="audio-conv-btn" class="btn mt-1 hidden">Convert</button>
                    <div id="audio-conv-output" class="mt-1"></div>
                `,
                onMount: () => {
                    showNotification("This tool is a placeholder. Full implementation requires Web Audio API.", 4000);
                    // Basic preview and button show/hide
                    const input = document.getElementById('audio-conv-input');
                    const preview = document.getElementById('audio-conv-preview');
                    const convertBtn = document.getElementById('audio-conv-btn');
                    const outputDiv = document.getElementById('audio-conv-output');
                    let mediaRecorder, chunks = [];

                    input.addEventListener('change', e => {
                        if (e.target.files.length === 0) return;
                        const file = e.target.files[0];
                        const url = URL.createObjectURL(file);
                        preview.src = url;
                        preview.classList.remove('hidden');
                        convertBtn.classList.remove('hidden');

                        // Enable recording from audio element for conversion
                        if (preview.captureStream) {
                            convertBtn.onclick = () => {
                                if (mediaRecorder && mediaRecorder.state === 'recording') {
                                    showNotification("Already converting. Please wait.", 3000);
                                    return;
                                }
                                showNotification("Conversion started...", 3000);
                                convertBtn.disabled = true;
                                convertBtn.textContent = "Converting...";

                                const stream = preview.captureStream();
                                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm; codecs=opus' }); // Using Opus codec for better quality

                                mediaRecorder.ondataavailable = e => chunks.push(e.data);

                                mediaRecorder.onstop = () => {
                                    const blob = new Blob(chunks, { type: 'audio/webm; codecs=opus' });
                                    const blobUrl = URL.createObjectURL(blob);
                                    outputDiv.innerHTML = `
                                        <p>Conversion to WEBM/Opus complete!</p>
                                        <button class="btn mt-1" id="download-converted-audio">Download Audio</button>
                                    `;
                                    document.getElementById('download-converted-audio').addEventListener('click', () => {
                                        if (window.Android && typeof window.Android.downloadFile === 'function') {
                                            const reader = new FileReader();
                                            reader.onloadend = function() {
                                                window.Android.downloadFile(reader.result, 'converted-audio.webm');
                                                showNotification("Audio download initiated via Android.", 3000);
                                            };
                                            reader.readAsDataURL(blob);
                                        } else {
                                            const a = document.createElement('a');
                                            a.href = blobUrl;
                                            a.download = 'converted-audio.webm';
                                            document.body.appendChild(a);
                                            a.click();
                                            document.body.removeChild(a);
                                            showNotification("Audio download started (browser fallback).", 3000);
                                        }
                                    });
                                    convertBtn.disabled = false;
                                    convertBtn.textContent = "Convert";
                                    chunks = [];
                                };

                                preview.currentTime = 0; // Start from the beginning
                                preview.play();
                                mediaRecorder.start();

                                preview.onended = () => {
                                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                                        mediaRecorder.stop();
                                    }
                                };
                            };
                        } else {
                            showNotification("Your browser/WebView does not support direct audio capture for conversion.", 5000);
                            convertBtn.disabled = true;
                        }
                    });
                }
            }),
            'audio-trimmer': () => ({
                title: 'Audio Trimmer',
                content: `
                    <input type="file" id="audio-trim-input" class="tool-input" accept="audio/*">
                    <p>Start Time (seconds): <input type="number" id="audio-trim-start" class="tool-input" value="0" min="0"></p>
                    <p>End Time (seconds): <input type="number" id="audio-trim-end" class="tool-input" value="10" min="0"></p>
                    <button id="audio-trim-btn" class="btn" disabled>Trim Audio</button>
                    <div id="audio-trim-output" class="mt-1"></div>
                `,
                onMount: () => {
                    showNotification("Audio Trimmer is a placeholder due to complexity. Full implementation requires Web Audio API for precise trimming.", 6000);

                    const input = document.getElementById('audio-trim-input');
                    const startInput = document.getElementById('audio-trim-start');
                    const endInput = document.getElementById('audio-trim-end');
                    const trimBtn = document.getElementById('audio-trim-btn');
                    const outputDiv = document.getElementById('audio-trim-output');
                    let audioContext, audioBuffer;

                    input.addEventListener('change', async (e) => {
                        if (e.target.files.length === 0) return;
                        const file = e.target.files[0];

                        // Use Web Audio API for actual trimming
                        if (window.AudioContext || window.webkitAudioContext) {
                            audioContext = new (window.AudioContext || window.webkitAudioContext)();
                            const arrayBuffer = await file.arrayBuffer();
                            try {
                                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                                endInput.value = audioBuffer.duration.toFixed(2); // Set default end to full duration
                                trimBtn.disabled = false;
                                showNotification(`Audio loaded. Duration: ${audioBuffer.duration.toFixed(2)} seconds.`, 3000);
                            } catch (error) {
                                showNotification("Error decoding audio file: " + error.message, 5000);
                                trimBtn.disabled = true;
                            }
                        } else {
                            showNotification("Web Audio API not supported. Audio trimming cannot be performed.", 5000);
                            trimBtn.disabled = true;
                        }
                    });

                    trimBtn.addEventListener('click', () => {
                        if (!audioBuffer) {
                            showNotification("Please load an audio file first.", 3000);
                            return;
                        }

                        const startTime = parseFloat(startInput.value);
                        const endTime = parseFloat(endInput.value);

                        if (isNaN(startTime) || isNaN(endTime) || startTime < 0 || endTime > audioBuffer.duration || startTime >= endTime) {
                            showNotification("Invalid trim times. Please check start and end values.", 4000);
                            return;
                        }

                        showNotification("Trimming audio...", 3000);
                        trimBtn.disabled = true;

                        const duration = endTime - startTime;
                        const numberOfChannels = audioBuffer.numberOfChannels;
                        const sampleRate = audioBuffer.sampleRate;
                        const startOffset = startTime * sampleRate;
                        const endOffset = endTime * sampleRate;

                        const trimmedBuffer = audioContext.createBuffer(numberOfChannels, duration * sampleRate, sampleRate);

                        for (let i = 0; i < numberOfChannels; i++) {
                            const originalChannelData = audioBuffer.getChannelData(i);
                            const trimmedChannelData = trimmedBuffer.getChannelData(i);
                            for (let j = 0; j < trimmedChannelData.length; j++) {
                                trimmedChannelData[j] = originalChannelData[startOffset + j];
                            }
                        }

                        // Export trimmed audio (e.g., as WAV)
                        // This part is complex and often requires a library or server-side processing for proper encoding (e.g., to MP3/AAC)
                        // For simplicity, we'll offer a raw WAV or basic playback for this example.
                        // For Android, we'd need to convert this ArrayBuffer to a Blob/DataURL and then pass it.

                        // Placeholder for actual download (converting to WAV for demonstration)
                        const exportWAV = (audioBuffer) => {
                            const wav = audioBufferToWav(audioBuffer);
                            const blob = new Blob([wav], { type: 'audio/wav' });
                            const blobUrl = URL.createObjectURL(blob);

                            outputDiv.innerHTML = `
                                <p>Audio trimmed successfully!</p>
                                <audio controls src="${blobUrl}" style="width:100%; margin-top:1rem;"></audio>
                                <button class="btn mt-1" id="download-trimmed-audio">Download Trimmed WAV</button>
                            `;

                            document.getElementById('download-trimmed-audio').addEventListener('click', () => {
                                if (window.Android && typeof window.Android.downloadFile === 'function') {
                                    const reader = new FileReader();
                                    reader.onloadend = function() {
                                        window.Android.downloadFile(reader.result, 'trimmed-audio.wav');
                                        showNotification("Trimmed audio download initiated via Android.", 3000);
                                    };
                                    reader.readAsDataURL(blob);
                                } else {
                                    const a = document.createElement('a');
                                    a.href = blobUrl;
                                    a.download = 'trimmed-audio.wav';
                                    document.body.appendChild(a);
                                    a.click();
                                    document.body.removeChild(a);
                                    showNotification("Trimmed audio download started (browser fallback).", 3000);
                                }
                            });
                            trimBtn.disabled = false;
                        };
                        exportWAV(trimmedBuffer);
                    });

                    // Helper function to convert AudioBuffer to WAV ArrayBuffer
                    // Source: https://github.com/vdsabev/AudioBufferToWav/blob/master/AudioBufferToWav.js (Simplified for this use case)
                    function audioBufferToWav(buffer) {
                        const numOfChan = buffer.numberOfChannels,
                              length = buffer.length * numOfChan * 2 + 44, // + 44 for header
                              bufferArray = new ArrayBuffer(length),
                              view = new DataView(bufferArray);

                        let offset = 0;
                        const writeString = (str) => {
                            for (let i = 0; i < str.length; i++) {
                                view.setUint8(offset + i, str.charCodeAt(i));
                            }
                            offset += str.length;
                        };
                        const writeUint32 = (val) => {
                            view.setUint32(offset, val, true);
                            offset += 4;
                        };
                        const writeUint16 = (val) => {
                            view.setUint16(offset, val, true);
                            offset += 2;
                        };

                        // RIFF header
                        writeString('RIFF');
                        writeUint32(length - 8); // file length - 8
                        writeString('WAVE');
                        // FMT sub-chunk
                        writeString('fmt ');
                        writeUint32(16); // subchunk1 size = 16
                        writeUint16(1); // audio format (PCM = 1)
                        writeUint16(numOfChan); // num of channels
                        writeUint32(buffer.sampleRate); // sample rate
                        writeUint32(buffer.sampleRate * numOfChan * 2); // byte rate (sample rate * num channels * bytes per sample)
                        writeUint16(numOfChan * 2); // block align (num channels * bytes per sample)
                        writeUint16(16); // bits per sample
                        // data sub-chunk
                        writeString('data');
                        writeUint32(length - offset); // data size

                        for (let i = 0; i < buffer.length; i++) {
                            for (let channel = 0; channel < buffer.numberOfChannels; channel++) {
                                const s = Math.max(-1, Math.min(1, buffer.getChannelData(channel)[i]));
                                view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
                                offset += 2;
                            }
                        }
                        return bufferArray;
                    }
                }
            }),
            'age-calculator': () => ({
                content: `<input type="date" id="age-dob-input" class="tool-input"><button id="age-calc-btn" class="btn">Calculate Age</button><div id="age-result" class="result-box mt-1"></div>`,
                onMount: () => {
                    document.getElementById('age-calc-btn').addEventListener('click', () => {
                        const dobInput = document.getElementById('age-dob-input');
                        const resultBox = document.getElementById('age-result');
                        if (!dobInput.value) {
                            resultBox.textContent = "Please select a date.";
                            return;
                        }
                        const dob = new Date(dobInput.value);
                        const today = new Date();
                        let age = today.getFullYear() - dob.getFullYear();
                        const m = today.getMonth() - dob.getMonth();
                        if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
                            age--;
                        }
                        resultBox.textContent = `You are ${age} years old.`;
                    });
                }
            }),
            'emi-calculator': () => ({
                content: `<label for="emi-principal">Loan Amount ($):</label><input type="number" id="emi-principal" class="tool-input" placeholder="e.g., 100000"><label for="emi-rate">Annual Interest Rate (%):</label><input type="number" id="emi-rate" class="tool-input" placeholder="e.g., 7.5"><label for="emi-tenure">Loan Tenure (Years):</label><input type="number" id="emi-tenure" class="tool-input" placeholder="e.g., 10"><button id="emi-calc-btn" class="btn">Calculate EMI</button><div id="emi-result" class="result-box mt-1"></div>`,
                onMount: () => {
                    document.getElementById('emi-calc-btn').addEventListener('click', () => {
                        const P = parseFloat(document.getElementById('emi-principal').value);
                        const annualRate = parseFloat(document.getElementById('emi-rate').value);
                        const T = parseFloat(document.getElementById('emi-tenure').value);
                        const resultBox = document.getElementById('emi-result');

                        if (isNaN(P) || isNaN(annualRate) || isNaN(T) || P <= 0 || annualRate <= 0 || T <= 0) {
                            resultBox.textContent = "Please enter valid positive numbers in all fields.";
                            return;
                        }
                        const R = (annualRate / 12) / 100;
                        const N = T * 12;
                        const EMI = (P * R * Math.pow(1 + R, N)) / (Math.pow(1 + R, N) - 1);

                        if (isNaN(EMI)) {
                            resultBox.textContent = "Could not calculate. Please check your inputs.";
                        } else {
                            resultBox.textContent = `Your monthly EMI is: $${EMI.toFixed(2)}`;
                        }
                    });
                }
            }),
            'sip-calculator': () => ({
                content: `<label for="sip-investment">Monthly Investment ($):</label><input type="number" id="sip-investment" class="tool-input" placeholder="e.g., 5000"><label for="sip-rate">Expected Annual Return Rate (%):</label><input type="number" id="sip-rate" class="tool-input" placeholder="e.g., 12"><label for="sip-tenure">Investment Period (Years):</label><input type="number" id="sip-tenure" class="tool-input" placeholder="e.g., 15"><button id="sip-calc-btn" class="btn">Calculate</button><div id="sip-result" class="result-box mt-1"></div>`,
                onMount: () => {
                    document.getElementById('sip-calc-btn').addEventListener('click', () => {
                        const P = parseFloat(document.getElementById('sip-investment').value);
                        const annualRate = parseFloat(document.getElementById('sip-rate').value);
                        const T = parseFloat(document.getElementById('sip-tenure').value);
                        const resultBox = document.getElementById('sip-result');

                        if (isNaN(P) || isNaN(annualRate) || isNaN(T) || P <= 0 || annualRate <= 0 || T <= 0) {
                            resultBox.textContent = "Please enter valid positive numbers.";
                            return;
                        }
                        const n = T * 12;
                        const i = (annualRate / 100) / 12;
                        const M = P * ((Math.pow(1 + i, n) - 1) / i) * (1 + i);
                        const totalInvested = P * n;
                        const wealthGained = M - totalInvested;

                        resultBox.innerHTML = `<p>Total Invested: $${totalInvested.toFixed(2)}</p><p>Wealth Gained: $${wealthGained.toFixed(2)}</p><p><strong>Estimated Future Value: $${M.toFixed(2)}</strong></p>`;
                    });
                }
            }),
            'bmi-calculator': () => ({
                content: `<div class="tool-controls"><select id="bmi-units" class="tool-select"><option value="metric">Metric (kg, cm)</option><option value="imperial">Imperial (lbs, in)</option></select></div><div id="bmi-metric-inputs"><label for="bmi-weight-kg">Weight (kg):</label><input type="number" id="bmi-weight-kg" class="tool-input"><label for="bmi-height-cm">Height (cm):</label><input type="number" id="bmi-height-cm" class="tool-input"></div><div id="bmi-imperial-inputs" class="hidden"><label for="bmi-weight-lbs">Weight (lbs):</label><input type="number" id="bmi-weight-lbs" class="tool-input"><label for="bmi-height-in">Height (in):</label><input type="number" id="bmi-height-in" class="tool-input"></div><button id="bmi-calc-btn" class="btn">Calculate BMI</button><div id="bmi-result" class="result-box mt-1"></div>`,
                onMount: () => {
                    const unitSelect = document.getElementById('bmi-units');
                    const metricInputs = document.getElementById('bmi-metric-inputs');
                    const imperialInputs = document.getElementById('bmi-imperial-inputs');

                    unitSelect.addEventListener('change', () => {
                        metricInputs.classList.toggle('hidden', unitSelect.value === 'imperial');
                        imperialInputs.classList.toggle('hidden', unitSelect.value === 'metric');
                    });

                    document.getElementById('bmi-calc-btn').addEventListener('click', () => {
                        let weight, height;
                        const resultBox = document.getElementById('bmi-result');

                        if (unitSelect.value === 'metric') {
                            weight = parseFloat(document.getElementById('bmi-weight-kg').value);
                            height = parseFloat(document.getElementById('bmi-height-cm').value) / 100; // Convert cm to meters
                        } else {
                            weight = parseFloat(document.getElementById('bmi-weight-lbs').value);
                            height = parseFloat(document.getElementById('bmi-height-in').value);
                        }

                        if (isNaN(weight) || isNaN(height) || weight <= 0 || height <= 0) {
                            resultBox.textContent = "Please enter valid weight and height.";
                            return;
                        }

                        let bmi;
                        if (unitSelect.value === 'metric') {
                            bmi = weight / (height * height);
                        } else {
                            bmi = (weight / (height * height)) * 703; // Imperial BMI formula
                        }

                        let category = '';
                        if (bmi < 18.5) category = 'Underweight';
                        else if (bmi < 24.9) category = 'Normal weight';
                        else if (bmi < 29.9) category = 'Overweight';
                        else category = 'Obesity';

                        resultBox.innerHTML = `Your BMI is <strong>${bmi.toFixed(1)}</strong>. This is considered <strong>${category}</strong>.`;
                    });
                }
            }),
            'qr-code-generator': () => ({
                content: `<input type="text" id="qr-text" class="tool-input" placeholder="https://example.com"><button id="qr-gen-btn" class="btn">Generate QR</button><div id="qr-output" class="text-center mt-1"></div>`,
                onMount: () => {
                    const qrText = document.getElementById('qr-text');
                    const genBtn = document.getElementById('qr-gen-btn');
                    const output = document.getElementById('qr-output');

                    genBtn.addEventListener('click', () => {
                        const text = qrText.value.trim();
                        if (!text) {
                            showNotification("Please enter text or a URL for the QR code.", 3000);
                            return;
                        }
                        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(text)}`;
                        output.innerHTML = `
                            <img src="${qrUrl}" alt="Generated QR Code" style="border:5px solid white; border-radius:var(--border-radius);">
                            <button class="btn mt-1" id="download-qr-code">Download SVG</button>
                        `;

                        document.getElementById('download-qr-code').addEventListener('click', () => {
                            const svgUrl = `${qrUrl}&format=svg`;
                            // Fetch the SVG data and then pass it to Android as Data URL
                            fetch(svgUrl)
                                .then(response => response.blob())
                                .then(blob => {
                                    const reader = new FileReader();
                                    reader.onloadend = function() {
                                        if (window.Android && typeof window.Android.downloadFile === 'function') {
                                            window.Android.downloadFile(reader.result, 'qrcode.svg');
                                            showNotification("QR code download initiated via Android.", 3000);
                                        } else {
                                            const a = document.createElement('a');
                                            a.href = reader.result;
                                            a.download = 'qrcode.svg';
                                            document.body.appendChild(a);
                                            a.click();
                                            document.body.removeChild(a);
                                            showNotification("QR code download started (browser fallback).", 3000);
                                        }
                                    };
                                    reader.readAsDataURL(blob);
                                })
                                .catch(e => showNotification("Failed to download QR code.", 3000));
                        });
                    });
                }
            }),
            'password-generator': () => ({
                content: `
                    <label for="pass-length">Password Length: <span id="pass-length-val">16</span></label>
                    <input type="range" id="pass-length" min="8" max="32" value="16" class="tool-input">
                    <div class="tool-controls">
                        <label><input type="checkbox" id="pass-upper" checked> Uppercase</label>
                        <label><input type="checkbox" id="pass-lower" checked> Lowercase</label>
                        <label><input type="checkbox" id="pass-nums" checked> Numbers</label>
                        <label><input type="checkbox" id="pass-syms" checked> Symbols</label>
                    </div>
                    <button id="pass-gen-btn" class="btn mt-1">Generate</button>
                    <div id="pass-result" class="result-box mt-1" style="cursor:pointer;" title="Click to copy"></div>
                `,
                onMount: () => {
                    const lengthSlider = document.getElementById('pass-length');
                    const lengthVal = document.getElementById('pass-length-val');
                    const resultBox = document.getElementById('pass-result');
                    const genBtn = document.getElementById('pass-gen-btn');
                    const options = {
                        upper: document.getElementById('pass-upper'),
                        lower: document.getElementById('pass-lower'),
                        nums: document.getElementById('pass-nums'),
                        syms: document.getElementById('pass-syms'),
                    };
                    const chars = {
                        upper: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
                        lower: 'abcdefghijklmnopqrstuvwxyz',
                        nums: '0123456789',
                        syms: '!@#$%^&*()_+-=[]{}|;:,.<>?'
                    };

                    lengthSlider.addEventListener('input', () => lengthVal.textContent = lengthSlider.value);

                    genBtn.addEventListener('click', () => {
                        const length = parseInt(lengthSlider.value);
                        let charset = '';
                        if (options.upper.checked) charset += chars.upper;
                        if (options.lower.checked) charset += chars.lower;
                        if (options.nums.checked) charset += chars.nums;
                        if (options.syms.checked) charset += chars.syms;

                        if (charset === '') {
                            resultBox.textContent = "Please select at least one character type.";
                            return;
                        }

                        let password = '';
                        for (let i = 0; i < length; i++) {
                            password += charset.charAt(Math.floor(Math.random() * charset.length));
                        }
                        resultBox.textContent = password;
                        showNotification("Password generated!", 2000);
                    });

                    resultBox.addEventListener('click', () => {
                        if (resultBox.textContent && resultBox.textContent.length > 1) {
                            navigator.clipboard.writeText(resultBox.textContent)
                                .then(() => showNotification("Password copied to clipboard!", 2000))
                                .catch(err => showNotification("Failed to copy password.", 2000));
                        }
                    });
                }
            }),
            'word-counter': () => ({
                content: `<textarea id="wc-text" class="tool-textarea" placeholder="Start typing or paste your text here..."></textarea><div id="wc-result" class="result-box">Words: 0 | Characters: 0 | Sentences: 0</div>`,
                onMount: () => {
                    const textarea = document.getElementById('wc-text');
                    const resultBox = document.getElementById('wc-result');

                    textarea.addEventListener('input', () => {
                        const text = textarea.value;
                        const words = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
                        const chars = text.length;
                        const sentences = (text.match(/[.!?]+/g) || []).length;
                        resultBox.textContent = `Words: ${words} | Characters: ${chars} | Sentences: ${sentences}`;
                    });
                }
            }),
            'base64-encoder': () => ({
                content: `<textarea id="b64-input" class="tool-textarea" placeholder="Enter text to encode or Base64 to decode..."></textarea><div class="tool-controls"><button id="b64-encode-btn" class="btn">Encode</button><button id="b64-decode-btn" class="btn btn-secondary">Decode</button></div><div id="b64-result" class="result-box mt-1"></div>`,
                onMount: () => {
                    const input = document.getElementById('b64-input');
                    const resultBox = document.getElementById('b64-result');

                    document.getElementById('b64-encode-btn').addEventListener('click', () => {
                        try {
                            resultBox.textContent = btoa(input.value);
                            showNotification("Text encoded to Base64!", 2000);
                        } catch(e) {
                            resultBox.textContent = "Error encoding text.";
                            showNotification("Error: Could not encode text.", 3000);
                        }
                    });

                    document.getElementById('b64-decode-btn').addEventListener('click', () => {
                        try {
                            resultBox.textContent = atob(input.value);
                            showNotification("Base64 decoded to text!", 2000);
                        } catch(e) {
                            resultBox.textContent = "Invalid Base64 string.";
                            showNotification("Error: Invalid Base64 string.", 3000);
                        }
                    });
                }
            }),
            'json-formatter': () => ({
                content: `<textarea id="json-input" class="tool-textarea" placeholder="Paste your JSON here..."></textarea><button id="json-format-btn" class="btn">Format JSON</button><div id="json-result" class="result-box mt-1"><pre><code id="json-output"></code></pre></div>`,
                onMount: () => {
                    const input = document.getElementById('json-input');
                    const outputCode = document.getElementById('json-output');
                    const resultBox = document.getElementById('json-result');

                    document.getElementById('json-format-btn').addEventListener('click', () => {
                        try {
                            const jsonObj = JSON.parse(input.value);
                            outputCode.textContent = JSON.stringify(jsonObj, null, 4);
                            resultBox.style.borderColor = 'var(--color-border)';
                            showNotification("JSON formatted successfully!", 2000);
                        } catch (e) {
                            outputCode.textContent = `Invalid JSON: ${e.message}`;
                            resultBox.style.borderColor = 'red';
                            showNotification(`Invalid JSON: ${e.message}`, 4000);
                        }
                    });
                }
            }),
            'color-picker': () => ({
                content: `
                    <div class="text-center">
                        <input type="color" id="color-picker-input" value="#007bff" style="width:150px; height:150px; border:none; background:none; padding:0; border-radius: 50%; cursor: pointer;">
                    </div>
                    <div id="color-values" class="result-box mt-1"></div>
                `,
                onMount: () => {
                    const picker = document.getElementById('color-picker-input');
                    const valuesBox = document.getElementById('color-values');

                    function updateValues(hex) {
                        const rgb = hexToRgb(hex);
                        const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
                        valuesBox.innerHTML = `
                            <strong>HEX:</strong> ${hex}<br>
                            <strong>RGB:</strong> rgb(${rgb.r}, ${rgb.g}, ${rgb.b})<br>
                            <strong>HSL:</strong> hsl(${hsl.h}, ${hsl.s}%, ${hsl.l}%)
                        `;
                    }

                    picker.addEventListener('input', () => updateValues(picker.value));
                    updateValues(picker.value); // Initial load

                    function hexToRgb(hex) {
                        let r = 0, g = 0, b = 0;
                        if (hex.length == 4) {
                            r = "0x" + hex[1] + hex[1];
                            g = "0x" + hex[2] + hex[2];
                            b = "0x" + hex[3] + hex[3];
                        } else if (hex.length == 7) {
                            r = "0x" + hex[1] + hex[2];
                            g = "0x" + hex[3] + hex[4];
                            b = "0x" + hex[5] + hex[6];
                        }
                        return { r: +r, g: +g, b: +b };
                    }

                    function rgbToHsl(r, g, b) {
                        r /= 255; g /= 255; b /= 255;
                        let max = Math.max(r, g, b), min = Math.min(r, g, b);
                        let h, s, l = (max + min) / 2;

                        if (max == min) {
                            h = s = 0; // achromatic
                        } else {
                            let d = max - min;
                            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                            switch (max) {
                                case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                                case g: h = (b - r) / d + 2; break;
                                case b: h = (r - g) / d + 4; break;
                            }
                            h /= 6;
                        }
                        return { h: Math.round(h * 360), s: Math.round(s * 100), l: Math.round(l * 100) };
                    }
                }
            }),
            'text-to-speech': () => ({
                content: `<textarea id="tts-text" class="tool-textarea" placeholder="Enter text to speak..."></textarea><label for="tts-voice">Voice:</label><select id="tts-voice" class="tool-select"></select><div class="tool-controls"><button id="tts-speak-btn" class="btn">Speak</button><button id="tts-stop-btn" class="btn btn-secondary">Stop</button></div>`,
                onMount: () => {
                    const synth = window.speechSynthesis;
                    if (!synth) {
                        showNotification("Text-to-Speech is not supported in this browser/WebView.", 5000);
                        return;
                    }

                    const textInput = document.getElementById('tts-text');
                    const voiceSelect = document.getElementById('tts-voice');
                    let voices = [];

                    function populateVoiceList() {
                        voices = synth.getVoices().sort((a, b) => a.name.localeCompare(b.name)); // Sort voices alphabetically
                        voiceSelect.innerHTML = voices.map((voice, i) =>
                            `<option value="${i}" ${voice.default ? 'selected' : ''}>${voice.name} (${voice.lang})</option>`
                        ).join('');
                        if (voices.length === 0) {
                            showNotification("No Text-to-Speech voices found. Please check device settings.", 5000);
                        }
                    }

                    // Attempt to populate voices immediately
                    populateVoiceList();

                    // Listen for when voices are loaded/changed
                    if (synth.onvoiceschanged !== undefined) {
                        synth.onvoiceschanged = populateVoiceList;
                    } else {
                        // Fallback for browsers that don't trigger onvoiceschanged immediately
                        setTimeout(populateVoiceList, 500); // Try again after a short delay
                    }

                    document.getElementById('tts-speak-btn').addEventListener('click', () => {
                        if (synth.speaking) {
                            showNotification("Already speaking. Please stop current speech first.", 3000);
                            return;
                        }
                        if (textInput.value.trim() !== '') {
                            const utterThis = new SpeechSynthesisUtterance(textInput.value);
                            utterThis.voice = voices[voiceSelect.value];
                            // Optional: Set language explicitly if voice is not found
                            if (!utterThis.voice && voices.length > 0) {
                                utterThis.voice = voices.find(v => v.lang.startsWith('en')) || voices[0];
                            }
                            synth.speak(utterThis);
                            showNotification("Speaking...", 2000);
                        } else {
                            showNotification("Please enter text to speak.", 3000);
                        }
                    });

                    document.getElementById('tts-stop-btn').addEventListener('click', () => {
                        synth.cancel();
                        showNotification("Speech stopped.", 2000);
                    });
                }
            }),
            'speech-to-text': () => ({
                content: `<div class="tool-controls"><button id="stt-start-btn" class="btn">Start Listening</button><button id="stt-stop-btn" class="btn btn-secondary">Stop Listening</button></div><div id="stt-result" class="result-box mt-1">Your transcribed text will appear here...</div>`,
                onMount: () => {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    if (!SpeechRecognition) {
                        showNotification("Speech-to-Text is not supported in this browser/WebView.", 5000);
                        return;
                    }
                    const recognition = new SpeechRecognition();
                    recognition.continuous = true; // Keep listening even if user pauses
                    recognition.interimResults = true; // Show results while speaking
                    recognition.lang = 'en-US'; // Set default language

                    const startBtn = document.getElementById('stt-start-btn');
                    const stopBtn = document.getElementById('stt-stop-btn');
                    const resultBox = document.getElementById('stt-result');
                    let final_transcript = '';

                    recognition.onresult = (event) => {
                        let interim_transcript = '';
                        for (let i = event.resultIndex; i < event.results.length; ++i) {
                            if (event.results[i].isFinal) {
                                final_transcript += event.results[i][0].transcript;
                            } else {
                                interim_transcript += event.results[i][0].transcript;
                            }
                        }
                        resultBox.innerHTML = final_transcript + `<span style="color:var(--color-text-secondary);">${interim_transcript}</span>`;
                    };

                    recognition.onerror = (event) => {
                        showNotification(`Speech recognition error: ${event.error}`, 5000);
                        startBtn.disabled = false;
                        stopBtn.disabled = true;
                    };

                    recognition.onend = () => {
                        showNotification("Speech recognition stopped.", 3000);
                        startBtn.disabled = false;
                        stopBtn.disabled = true;
                    };

                    startBtn.addEventListener('click', () => {
                        final_transcript = '';
                        resultBox.textContent = 'Listening...';
                        recognition.start();
                        startBtn.disabled = true;
                        stopBtn.disabled = false;
                        showNotification("Listening for speech...", 3000);
                    });

                    stopBtn.addEventListener('click', () => {
                        recognition.stop();
                        showNotification("Stopped listening.", 2000);
                    });
                }
            }),
            'unit-converter': () => ({
                content: `
                    <div class="tool-controls">
                        <input type="number" id="unit-input" class="tool-input" placeholder="Enter value">
                        <select id="unit-from" class="tool-select"></select>
                        <span>to</span>
                        <select id="unit-to" class="tool-select"></select>
                    </div>
                    <select id="unit-category" class="tool-select mt-1">
                        <option value="length">Length</option>
                        <option value="weight">Weight</option>
                        <option value="temperature">Temperature</option>
                    </select>
                    <div id="unit-result" class="result-box mt-1"></div>
                `,
                onMount: () => {
                    const units = {
                        length: { meter: 1, kilometer: 1000, centimeter: 0.01, mile: 1609.34, foot: 0.3048, inch: 0.0254 },
                        weight: { gram: 1, kilogram: 1000, pound: 453.592, ounce: 28.3495 },
                        temperature: {} // Temperature handled separately due to non-linear conversion
                    };

                    const categorySelect = document.getElementById('unit-category');
                    const fromSelect = document.getElementById('unit-from');
                    const toSelect = document.getElementById('unit-to');
                    const input = document.getElementById('unit-input');
                    const resultBox = document.getElementById('unit-result');

                    function populateUnits() {
                        const category = categorySelect.value;
                        let options = '';
                        if (category === 'temperature') {
                            options = `<option value="celsius">Celsius</option><option value="fahrenheit">Fahrenheit</option><option value="kelvin">Kelvin</option>`;
                        } else {
                            options = Object.keys(units[category]).map(u => `<option value="${u}">${u.charAt(0).toUpperCase() + u.slice(1)}</option>`).join('');
                        }
                        fromSelect.innerHTML = options;
                        toSelect.innerHTML = options;
                        convert(); // Convert immediately when units change
                    }

                    function convert() {
                        const val = parseFloat(input.value);
                        if (isNaN(val)) {
                            resultBox.textContent = '';
                            return;
                        }

                        const category = categorySelect.value;
                        const fromUnit = fromSelect.value;
                        const toUnit = toSelect.value;
                        let result;

                        if (category === 'temperature') {
                            // Convert to Celsius first, then to target
                            let valCelsius;
                            if (fromUnit === 'celsius') valCelsius = val;
                            else if (fromUnit === 'fahrenheit') valCelsius = (val - 32) * 5/9;
                            else if (fromUnit === 'kelvin') valCelsius = val - 273.15;

                            if (toUnit === 'celsius') result = valCelsius;
                            else if (toUnit === 'fahrenheit') result = (valCelsius * 9/5) + 32;
                            else if (toUnit === 'kelvin') result = valCelsius + 273.15;
                        } else {
                            const baseValue = val * units[category][fromUnit]; // Convert to base unit (e.g., meters, grams)
                            result = baseValue / units[category][toUnit]; // Convert from base unit to target
                        }
                        resultBox.textContent = `${val} ${fromUnit.replace(/(\w)(\w*)/g, (g0,g1,g2) => g1.toUpperCase() + g2)} = ${result.toFixed(4)} ${toUnit.replace(/(\w)(\w*)/g, (g0,g1,g2) => g1.toUpperCase() + g2)}`;
                    }

                    categorySelect.addEventListener('change', populateUnits);
                    input.addEventListener('input', convert);
                    fromSelect.addEventListener('change', convert);
                    toSelect.addEventListener('change', convert);

                    populateUnits(); // Initial population
                }
            }),
            'timer-stopwatch': () => ({
                content: `
                    <div class="tool-controls">
                        <button id="ts-mode-stopwatch" class="btn">Stopwatch</button>
                        <button id="ts-mode-timer" class="btn btn-secondary">Timer</button>
                    </div>
                    <div id="ts-timer-inputs" class="hidden mt-1 tool-controls">
                        <input type="number" id="ts-hours" class="tool-input" min="0" placeholder="H">
                        <input type="number" id="ts-minutes" class="tool-input" min="0" max="59" placeholder="M">
                        <input type="number" id="ts-seconds" class="tool-input" min="0" max="59" placeholder="S">
                    </div>
                    <div id="ts-display" class="result-box mt-1" style="font-size: 2.5rem; text-align: center; font-family: 'Courier New', monospace;">00:00:00.000</div>
                    <div class="tool-controls mt-1">
                        <button id="ts-start-btn" class="btn">Start</button>
                        <button id="ts-stop-btn" class="btn btn-secondary">Stop</button>
                        <button id="ts-reset-btn" class="btn">Reset</button>
                    </div>
                `,
                onMount: () => {
                    let mode = 'stopwatch', interval, startTime, elapsedTime = 0, timerDuration = 0;
                    const display = document.getElementById('ts-display');
                    const timerInputs = document.getElementById('ts-timer-inputs');
                    const h_in = document.getElementById('ts-hours');
                    const m_in = document.getElementById('ts-minutes');
                    const s_in = document.getElementById('ts-seconds');

                    function formatTime(ms) {
                        const totalSeconds = Math.floor(ms / 1000);
                        const hours = Math.floor(totalSeconds / 3600);
                        const minutes = Math.floor((totalSeconds % 3600) / 60);
                        const seconds = totalSeconds % 60;
                        const milliseconds = Math.floor(ms % 1000);

                        const pad = (num, size = 2) => num.toString().padStart(size, '0');

                        if (hours > 0) {
                            return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}.${pad(milliseconds, 3)}`;
                        }
                        return `${pad(minutes)}:${pad(seconds)}.${pad(milliseconds, 3)}`;
                    }

                    function updateDisplay() {
                        if (mode === 'stopwatch') {
                            const now = Date.now();
                            elapsedTime = now - startTime;
                            display.textContent = formatTime(elapsedTime);
                        } else { // Timer mode
                            const remaining = timerDuration - (Date.now() - startTime);
                            if (remaining <= 0) {
                                clearInterval(interval);
                                interval = null;
                                display.textContent = '00:00:00.000';
                                showNotification("Timer finished!", 3000);
                                return;
                            }
                            display.textContent = formatTime(remaining);
                        }
                    }

                    document.getElementById('ts-mode-stopwatch').addEventListener('click', () => {
                        mode = 'stopwatch';
                        timerInputs.classList.add('hidden');
                        reset();
                    });

                    document.getElementById('ts-mode-timer').addEventListener('click', () => {
                        mode = 'timer';
                        timerInputs.classList.remove('hidden');
                        reset();
                    });

                    document.getElementById('ts-start-btn').addEventListener('click', () => {
                        if (interval) return; // Prevent multiple starts

                        if (mode === 'timer') {
                            const h = parseInt(h_in.value) || 0;
                            const m = parseInt(m_in.value) || 0;
                            const s = parseInt(s_in.value) || 0;
                            timerDuration = (h * 3600 + m * 60 + s) * 1000;
                            if (timerDuration <= 0) {
                                showNotification("Please set a timer duration.", 3000);
                                return;
                            }
                            // Adjust startTime so that (Date.now() - startTime) will be 0 at the beginning
                            startTime = Date.now();
                        } else { // Stopwatch
                            startTime = Date.now() - elapsedTime; // Resume from last stop
                        }

                        interval = setInterval(updateDisplay, 10); // Update every 10ms for smooth millisecond display
                        showNotification("Started!", 2000);
                    });

                    document.getElementById('ts-stop-btn').addEventListener('click', () => {
                        clearInterval(interval);
                        interval = null;
                        showNotification("Stopped.", 2000);
                    });

                    function reset() {
                        clearInterval(interval);
                        interval = null;
                        elapsedTime = 0;
                        timerDuration = 0;
                        if (mode === 'stopwatch') {
                            display.textContent = '00:00:00.000';
                        } else { // Timer
                            display.textContent = '00:00:00.000';
                            h_in.value = '';
                            m_in.value = '';
                            s_in.value = '';
                        }
                        showNotification("Reset.", 2000);
                    }
                    document.getElementById('ts-reset-btn').addEventListener('click', reset);
                }
            })
        };

        renderToolCards();
    });
    </script>
</body>
</html>
